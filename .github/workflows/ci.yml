name: CI - Build & Test Multi-Compiler (Phase 1.66)

on:
  push:
    branches: [ main, develop, phase-* ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      feature:
        description: 'Feature to test (tt, bits, limits, etc. or "all")'
        required: false
        default: 'tt'

# Cancelar runs anteriores si hay un nuevo push
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================================================
  # GCC Build & Test - Ubuntu (Sintaxis simplificada Fase 1.66)
  # ============================================================================
  gcc-build:
    name: GCC ${{ matrix.version }} - ${{ matrix.feature }} (${{ matrix.build_type }})
    runs-on: ubuntu-24.04
    
    strategy:
      fail-fast: false
      matrix:
        version: [13, 14, 15]
        build_type: [debug, release]
        feature: [tt, bits, limits, traits, concepts, numeric, cmath, algorithm, iostreams, format]
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Instalar GCC ${{ matrix.version }}
      run: |
        sudo add-apt-repository -y ppa:ubuntu-toolchain-r/test
        sudo apt update
        sudo apt install -y gcc-${{ matrix.version }} g++-${{ matrix.version }}
        g++-${{ matrix.version }} --version
    
    - name: Build and Test (Fase 1.66 syntax)
      run: |
        chmod +x scripts/wsl/build_gcc${{ matrix.version }}.bash
        # Nueva sintaxis simplificada: <feature> <mode> (sin TYPE)
        bash scripts/wsl/build_gcc${{ matrix.version }}.bash ${{ matrix.feature }} ${{ matrix.build_type }}
    
    - name: Upload GCC artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: gcc-${{ matrix.version }}-${{ matrix.feature }}-${{ matrix.build_type }}
        path: build/build_tests/gcc-${{ matrix.version }}/${{ matrix.build_type }}/
        retention-days: 7

  # ============================================================================
  # Clang Build & Test - Ubuntu (Fase 1.66)
  # ============================================================================
  clang-build:
    name: Clang ${{ matrix.version }} - ${{ matrix.feature }} (${{ matrix.build_type }})
    runs-on: ubuntu-24.04
    
    strategy:
      fail-fast: false
      matrix:
        version: [18, 19, 20, 21]
        build_type: [debug, release]
        feature: [tt, bits, limits, traits, concepts, numeric, cmath, algorithm, iostreams, format]
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Instalar Clang ${{ matrix.version }}
      run: |
        wget -O - https://apt.llvm.org/llvm-snapshot.gpg.key | sudo apt-key add -
        sudo add-apt-repository "deb http://apt.llvm.org/noble/ llvm-toolchain-noble-${{ matrix.version }} main"
        sudo apt update
        sudo apt install -y clang-${{ matrix.version }}
        clang-${{ matrix.version }} --version
    
    - name: Build and Test (Fase 1.66 syntax)
      run: |
        chmod +x scripts/wsl/build_clang${{ matrix.version }}.bash
        bash scripts/wsl/build_clang${{ matrix.version }}.bash ${{ matrix.feature }} ${{ matrix.build_type }}
    
    - name: Upload Clang artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: clang-${{ matrix.version }}-${{ matrix.feature }}-${{ matrix.build_type }}
        path: build/build_tests/clang-${{ matrix.version }}/${{ matrix.build_type }}/
        retention-days: 7

  # ============================================================================
  # MSVC Build & Test - Windows (NATIVO - PREINSTALADO)
  # ============================================================================
  msvc-build:
    name: MSVC - ${{ matrix.build_type }}
    runs-on: windows-latest
    
    strategy:
      fail-fast: false
      matrix:
        build_type: [debug, release]
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v2
    
    - name: Configurar entorno MSVC
      shell: pwsh
      run: |
        # Obtener vcvarsall.bat path
        $vcvarsPath = & python scripts/vcvars.py
        if ($vcvarsPath) {
          Write-Host "âœ“ Found vcvarsall.bat at: $vcvarsPath"
          echo "VCVARS_PATH=$vcvarsPath" >> $env:GITHUB_ENV
        } else {
          Write-Host "âš  vcvarsall.bat not found, using default path"
        }
    
    - name: Build tests with MSVC
      shell: cmd
      run: |
        call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
        bash -c "chmod +x scripts/build_extracted_tests.bash && ./scripts/build_extracted_tests.bash msvc ${{ matrix.build_type }}"
    
    - name: Run tests with MSVC
      shell: cmd
      run: |
        call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
        bash -c "chmod +x scripts/run_uint128_extracted_tests.bash && ./scripts/run_uint128_extracted_tests.bash msvc ${{ matrix.build_type }}"
    
    - name: Build demos con MSVC
      shell: cmd
      run: |
        call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
        cl /std:c++20 /EHsc /W4 demos\tutorials\tut_01_basic.cpp 2>nul || echo "Demo check completed"
      continue-on-error: true
    
    - name: Upload MSVC artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: msvc-${{ matrix.build_type }}-binaries
        path: build/build_tests/msvc/${{ matrix.build_type }}/
        retention-days: 7

  # ============================================================================
  # Intel oneAPI Build & Test - Ubuntu (OPCIONAL - SOLO EN PRs)
  # ============================================================================
  intel-build:
    name: Intel oneAPI - ${{ matrix.build_type }}
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'  # Solo en PRs para ahorrar tiempo
    
    strategy:
      fail-fast: false
      matrix:
        build_type: [release]  # Solo release para ahorrar tiempo
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Instalar Intel oneAPI
      run: |
        wget -O- https://apt.repos.intel.com/intel-gpg-keys/GPG-PUB-KEY-INTEL-SW-PRODUCTS.PUB | \
          gpg --dearmor | sudo tee /usr/share/keyrings/oneapi-archive-keyring.gpg > /dev/null
        echo "deb [signed-by=/usr/share/keyrings/oneapi-archive-keyring.gpg] https://apt.repos.intel.com/oneapi all main" | \
          sudo tee /etc/apt/sources.list.d/oneAPI.list
        sudo apt update
        sudo apt install -y intel-oneapi-compiler-dpcpp-cpp-and-cpp-classic
    
    - name: Build tests with Intel
      run: |
        source /opt/intel/oneapi/setvars.sh
        export CC=icx
        export CXX=icpx
        chmod +x scripts/build_extracted_tests.bash
        ./scripts/build_extracted_tests.bash intel ${{ matrix.build_type }}
    
    - name: Run tests with Intel
      run: |
        source /opt/intel/oneapi/setvars.sh
        chmod +x scripts/run_uint128_extracted_tests.bash
        ./scripts/run_uint128_extracted_tests.bash intel ${{ matrix.build_type }}
    
    - name: Upload Intel artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: intel-${{ matrix.build_type }}-binaries
        path: build/build_tests/intel/${{ matrix.build_type }}/
        retention-days: 7

  # ============================================================================
  # Sanitizers - ASan + UBSan (Solo Clang, Solo Debug)
  # ============================================================================
  sanitizers:
    name: Sanitizers (ASan + UBSan)
    runs-on: ubuntu-24.04
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Instalar Clang 19
      run: |
        wget -O - https://apt.llvm.org/llvm-snapshot.gpg.key | sudo apt-key add -
        sudo add-apt-repository "deb http://apt.llvm.org/noble/ llvm-toolchain-noble-19 main"
        sudo apt update
        sudo apt install -y clang-19
    
    - name: Build con AddressSanitizer
      run: |
        export CC=clang-19
        export CXX=clang++-19
        export CXXFLAGS="-fsanitize=address -fno-omit-frame-pointer -g"
        chmod +x scripts/build_extracted_tests.bash
        ./scripts/build_extracted_tests.bash clang debug
    
    - name: Tests con ASan
      run: |
        export ASAN_OPTIONS=detect_leaks=1
        chmod +x scripts/run_uint128_extracted_tests.bash
        ./scripts/run_uint128_extracted_tests.bash clang debug
    
    - name: Build con UndefinedBehaviorSanitizer
      run: |
        export CC=clang-19
        export CXX=clang++-19
        export CXXFLAGS="-fsanitize=undefined -fno-omit-frame-pointer -g"
        chmod +x scripts/build_extracted_tests.bash
        ./scripts/build_extracted_tests.bash clang debug
    
    - name: Tests con UBSan
      run: |
        chmod +x scripts/run_uint128_extracted_tests.bash
        ./scripts/run_uint128_extracted_tests.bash clang debug

  # ============================================================================
  # Benchmarks (Solo GCC Release para CI speed)
  # ============================================================================
  benchmarks:
    name: Benchmarks - GCC
    runs-on: ubuntu-24.04
    needs: gcc-build
    if: github.event_name == 'pull_request'  # Solo en PRs
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Instalar GCC 14
      run: |
        sudo apt update
        sudo apt install -y gcc-14 g++-14
    
    - name: Build benchmarks
      run: |
        export CC=gcc-14
        export CXX=g++-14
        chmod +x scripts/build_benchmarks.bash
        ./scripts/build_benchmarks.bash gcc release || echo "Benchmarks no disponibles aÃºn"
      continue-on-error: true
    
    - name: Run benchmarks
      run: |
        chmod +x scripts/run_benchmarks.bash
        ./scripts/run_benchmarks.bash gcc release || echo "Benchmarks no disponibles aÃºn"
      continue-on-error: true

    - name: Upload benchmark results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: benchmark-results
        path: |
          build/build_benchmarks/gcc/release/
          benchmark_results/
        retention-days: 30

  # ============================================================================
  # Code Quality - clang-format y anÃ¡lisis estÃ¡tico
  # ============================================================================
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-24.04
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Instalar herramientas
      run: |
        sudo apt update
        sudo apt install -y clang-format-19 clang-tidy-19
    
    - name: Verificar formato (clang-format)
      run: |
        find include -name "*.hpp" -o -name "*.h" | xargs clang-format-19 --dry-run --Werror || echo "âš  Format issues found (non-blocking)"
        find sources -name "*.cpp" | xargs clang-format-19 --dry-run --Werror || echo "âš  Format issues found (non-blocking)"
      continue-on-error: true  # No bloquear CI por formato
    
    - name: AnÃ¡lisis estÃ¡tico bÃ¡sico
      run: |
        echo "âœ“ Static analysis would run here"
        # clang-tidy analysis can be added here
      continue-on-error: true

  # ============================================================================
  # Summary Job - Dashboard CI (Fase 1.66)
  # ============================================================================
  ci-summary:
    name: CI Dashboard Summary
    runs-on: ubuntu-latest
    needs: [gcc-build, clang-build, msvc-build, sanitizers]
    if: always()
    
    steps:
    - name: Generate Dashboard
      run: |
        echo "## ðŸŽ¯ int128 Library - CI Dashboard (Phase 1.66)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š Compiler Matrix Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Compiler | Versions | Features | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|----------|----------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| GCC      | 13, 14, 15 | tt, bits, limits, traits, concepts, numeric, cmath, algorithm, iostreams, format | ${{ needs.gcc-build.result == 'success' && 'âœ… PASS' || 'âŒ FAIL' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Clang    | 18, 19, 20, 21 | tt, bits, limits, traits, concepts, numeric, cmath, algorithm, iostreams, format | ${{ needs.clang-build.result == 'success' && 'âœ… PASS' || 'âŒ FAIL' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| MSVC     | 2022 | tt | ${{ needs.msvc-build.result == 'success' && 'âœ… PASS' || 'âŒ FAIL' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Sanitizers | ASan + UBSan | tt | ${{ needs.sanitizers.result == 'success' && 'âœ… PASS' || 'âš ï¸ WARN' }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸ“ˆ Configuration Statistics" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **GCC Jobs:** 3 versions Ã— 10 features Ã— 2 modes = **60 configurations**" >> $GITHUB_STEP_SUMMARY
        echo "- **Clang Jobs:** 4 versions Ã— 10 features Ã— 2 modes = **80 configurations**" >> $GITHUB_STEP_SUMMARY
        echo "- **MSVC Jobs:** 1 version Ã— 1 feature Ã— 2 modes = **2 configurations**" >> $GITHUB_STEP_SUMMARY
        echo "- **Total Matrix:** **142 test configurations**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸ”§ Features Tested" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Feature | Description |" >> $GITHUB_STEP_SUMMARY
        echo "|---------|-------------|" >> $GITHUB_STEP_SUMMARY
        echo "| \`tt\` | Core template \`int128_base_t<S>\` |" >> $GITHUB_STEP_SUMMARY
        echo "| \`bits\` | Bit manipulation (popcount, clz, ctz) |" >> $GITHUB_STEP_SUMMARY
        echo "| \`limits\` | std::numeric_limits<> |" >> $GITHUB_STEP_SUMMARY
        echo "| \`traits\` | Type traits (is_integral, make_signed) |" >> $GITHUB_STEP_SUMMARY
        echo "| \`concepts\` | C++20 concepts |" >> $GITHUB_STEP_SUMMARY
        echo "| \`numeric\` | Numeric functions (gcd, lcm, sqrt) |" >> $GITHUB_STEP_SUMMARY
        echo "| \`cmath\` | Math functions (pow, abs, sign) |" >> $GITHUB_STEP_SUMMARY
        echo "| \`algorithm\` | STL algorithm compatibility |" >> $GITHUB_STEP_SUMMARY
        echo "| \`iostreams\` | Stream I/O operators |" >> $GITHUB_STEP_SUMMARY
        echo "| \`format\` | Formatting functions |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
    
    - name: Fail if critical jobs failed
      if: |
        needs.gcc-build.result == 'failure' ||
        needs.clang-build.result == 'failure' ||
        needs.msvc-build.result == 'failure'
      run: |
        echo "ðŸ’¥ CI failed - critical build failures detected"
        exit 1
    
    - name: Success
      if: |
        needs.gcc-build.result == 'success' &&
        needs.clang-build.result == 'success' &&
        needs.msvc-build.result == 'success'
      run: |
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… All Critical Builds Passed!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "The unified template \`int128_base_t<signedness S>\` compiles successfully with:" >> $GITHUB_STEP_SUMMARY
        echo "- GCC 13, 14, 15" >> $GITHUB_STEP_SUMMARY
        echo "- Clang 18, 19, 20, 21" >> $GITHUB_STEP_SUMMARY
        echo "- MSVC 2022" >> $GITHUB_STEP_SUMMARY
